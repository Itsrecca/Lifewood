<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Lifewood</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Manrope', sans-serif; }
        .processing-overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(19, 48, 32, 0.7); backdrop-filter: blur(2px);
            display: flex; align-items: center; justify-content: center;
            color: white; font-size: 1.2rem; font-weight: 700; border-radius: 0.5rem;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'lifewood-green': '#046241',
                        'lifewood-saffron': '#FFB347',
                        'lifewood-earth-yellow': '#FFC107',
                        'lifewood-dark': '#133020',
                    },
                    fontFamily: { 'sans': ['Manrope', 'sans-serif'] },
                },
            },
        };
    </script>
</head>
<body class="bg-lifewood-dark text-gray-200">

    <div id="login-section" class="min-h-screen flex flex-col items-center justify-center p-4">
        <div class="bg-white/5 backdrop-blur-sm p-8 rounded-xl shadow-2xl w-full max-w-sm">
            <div class="flex justify-center mb-6">
                 <div class="flex items-center space-x-2">
                    <svg class="w-10 h-10 text-lifewood-earth-yellow" viewBox="0 0 100 100" fill="currentColor"><path d="M50 10 L75 25 L75 75 L50 90 L25 75 L25 25 Z" /></svg>
                    <span class="text-3xl font-extrabold text-white">lifewood</span>
                </div>
            </div>
            <h2 class="text-xl font-bold text-center text-lifewood-earth-yellow mb-6">Admin Dashboard Login</h2>
            <form id="login-form">
                <div class="mb-4"><label for="username" class="block mb-2 text-sm font-medium text-gray-300">Username</label><input type="text" id="username" value="admin" class="w-full px-4 py-2 bg-lifewood-dark/50 border border-lifewood-green/50 rounded-lg focus:outline-none focus:ring-2 focus:ring-lifewood-earth-yellow transition" required></div>
                <div class="mb-6"><label for="password" class="block mb-2 text-sm font-medium text-gray-300">Password</label><input type="password" id="password" value="password" class="w-full px-4 py-2 bg-lifewood-dark/50 border border-lifewood-green/50 rounded-lg focus:outline-none focus:ring-2 focus:ring-lifewood-earth-yellow transition" required></div>
                <button type="submit" class="w-full bg-lifewood-earth-yellow text-lifewood-dark font-bold py-2 px-4 rounded-lg hover:bg-lifewood-saffron transition-colors">Login</button>
            </form>
            <p id="login-error" class="text-red-400 text-center mt-4"></p>
        </div>
    </div>

    <div id="dashboard-section" class="hidden">
        <header class="bg-lifewood-green/95 backdrop-blur-md shadow-lg sticky top-0 z-20">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8"><div class="flex items-center justify-between h-16"><div class="flex items-center space-x-2"><svg class="w-8 h-8 text-lifewood-earth-yellow" viewBox="0 0 100 100" fill="currentColor"><path d="M50 10 L75 25 L75 75 L50 90 L25 75 L25 25 Z" /></svg><span class="text-xl font-extrabold text-white">Admin Dashboard</span></div></div></div>
        </header>
        <main class="py-8"><div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8"><div class="mb-12"><h2 class="text-2xl font-extrabold text-white border-b-2 border-lifewood-green pb-3 mb-6">Pending Applications</h2><div id="pending-applications-container" class="space-y-6"></div></div><div><h2 class="text-2xl font-extrabold text-gray-400 border-b-2 border-gray-700 pb-3 mb-6">Application History</h2><div id="history-applications-container" class="space-y-6"></div></div></div></main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, updateDoc, orderBy, query } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        // This is the line that makes it work!
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-functions.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBaEPb1rYlIkq7MH732RA1FW5CH_Px0Aaw",
            authDomain: "lifewood-careers-de112.firebaseapp.com",
            projectId: "lifewood-careers-de112",
            storageBucket: "lifewood-careers-de112.firebasestorage.app",
            messagingSenderId: "1037659487257",
            appId: "1:1037659487257:web:0f3e2e97496327579afe88",
            measurementId: "G-L3V2NRK2FL"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // --- FIREBASE CLOUD FUNCTIONS METHOD (ACTIVE) ---
        const functions = getFunctions(app);
        // IMPORTANT: Replace these with your REAL Template IDs from Brevo
        const ACCEPTED_TEMPLATE_ID = 1; // <-- Put your "Accepted" Template ID here
        const REJECTED_TEMPLATE_ID = 2; // <-- Put your "Rejected" Template ID here

        let allApplications = [];
        const loginSection = document.getElementById('login-section');
        const dashboardSection = document.getElementById('dashboard-section');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const pendingContainer = document.getElementById('pending-applications-container');
        const historyContainer = document.getElementById('history-applications-container');
        
        // --- All the functions for rendering the page ---
        function handleLogin(event) {
            event.preventDefault();
            if (document.getElementById('username').value === 'admin' && document.getElementById('password').value === 'password') {
                loginSection.style.display = 'none';
                dashboardSection.style.display = 'block';
                listenForApplications();
            } else {
                loginError.textContent = 'Invalid username or password.';
            }
        }

        function listenForApplications() {
            const q = query(collection(db, "jobApplications"), orderBy("submittedAt", "desc"));
            onSnapshot(q, (querySnapshot) => {
                allApplications = [];
                querySnapshot.forEach(doc => allApplications.push({ id: doc.id, ...doc.data() }));
                const pendingApps = allApplications.filter(app => app.status === 'pending');
                const historyApps = allApplications.filter(app => app.status !== 'pending').sort((a, b) => (b.processedAt?.toMillis() || 0) - (a.processedAt?.toMillis() || 0));
                renderPending(pendingApps);
                renderHistory(historyApps);
            });
        }

        function renderPending(apps) {
            pendingContainer.innerHTML = apps.length === 0 ? '<p class="text-center text-gray-400 py-4">No pending applications.</p>' : '';
            apps.forEach(app => pendingContainer.appendChild(createApplicationCard(app, true)));
        }

        function renderHistory(apps) {
            historyContainer.innerHTML = apps.length === 0 ? '<p class="text-center text-gray-400 py-4">No processed applications in history.</p>' : '';
            apps.forEach(app => historyContainer.appendChild(createApplicationCard(app, false)));
        }

        function createApplicationCard(app, isPending) {
            const appCard = document.createElement('div');
            appCard.className = `relative overflow-hidden rounded-xl shadow-lg transition-all duration-300 ${isPending ? 'bg-white/5' : 'bg-transparent border border-white/10'}`;
            appCard.id = `card-${app.id}`;
            const date = isPending ? app.submittedAt?.toDate() : app.processedAt?.toDate();
            const dateString = date ? date.toLocaleString() : 'N/A';
            const actionButtons = `<button onclick="updateApplicationStatus('${app.id}', 'accepted')" class="flex-1 bg-green-600/80 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition">Accept</button><button onclick="updateApplicationStatus('${app.id}', 'rejected')" class="flex-1 bg-red-600/80 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition">Reject</button>`;
            appCard.innerHTML = `<div class="p-5"><div class="flex justify-between items-start flex-wrap gap-2"><h3 class="text-xl font-extrabold ${isPending ? 'text-lifewood-earth-yellow' : 'text-gray-300'}">${app.firstName} ${app.lastName}</h3><span class="capitalize text-xs font-bold px-3 py-1 rounded-full ${getStatusClass(app.status)}">${app.status}</span></div><p class="text-xs text-gray-400 mt-1">${isPending ? 'Submitted' : 'Processed'}: ${dateString}</p><div class="mt-4 pt-4 border-t border-white/10 grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-3 text-sm"><div><strong class="text-gray-400 block">Email:</strong><a href="mailto:${app.email}" class="text-blue-400 hover:underline">${app.email}</a></div><div><strong class="text-gray-400 block">Age:</strong>${app.age}</div><div><strong class="text-gray-400 block">Degree:</strong>${app.degree}</div><div><strong class="text-gray-400 block">Project:</strong>${app.projectAppliedFor}</div><div class="col-span-1 sm:col-span-2"><strong class="text-gray-400 block">Available:</strong>${app.startTime} - ${app.endTime}</div><div class="col-span-1 sm:col-span-2"><strong class="text-gray-400 block">Resume:</strong><a href="${app.resumeLink}" target="_blank" class="text-blue-400 hover:underline break-all">View Link</a></div><div class="col-span-1 sm:col-span-2"><strong class="text-gray-400 block">Experience:</strong><p class="whitespace-pre-wrap">${app.jobExperience}</p></div></div></div>${isPending ? `<div class="bg-black/20 p-3 mt-2 flex gap-3">${actionButtons}</div>` : ''}`;
            return appCard;
        }

        function getStatusClass(status) {
            return { accepted: 'bg-green-500/30 text-green-300 border border-green-500/50', rejected: 'bg-red-500/30 text-red-300 border border-red-500/50', pending: 'bg-yellow-500/30 text-yellow-300 border border-yellow-500/50' }[status];
        }

        // This is the function that calls your Cloud Function
        window.updateApplicationStatus = async (id, newStatus) => {
            const app = allApplications.find(a => a.id === id);
            if (!app || !confirm(`This will send a ${newStatus} email to ${app.firstName}. Are you sure?`)) return;

            const card = document.getElementById(`card-${id}`);
            const overlay = document.createElement('div');
            overlay.className = 'processing-overlay';
            overlay.innerText = 'Sending Email...';
            card.appendChild(overlay);

            try {
                const sendEmail = httpsCallable(functions, 'sendTransactionalEmail');
                await sendEmail({
                    email: app.email,
                    firstName: app.firstName,
                    lastName: app.lastName,
                    templateId: newStatus === 'accepted' ? ACCEPTED_TEMPLATE_ID : REJECTED_TEMPLATE_ID
                });
                
                const appDocRef = doc(db, "jobApplications", id);
                await updateDoc(appDocRef, { status: newStatus, processedAt: new Date() });
                alert(`Email sent successfully and application status updated.`);

            } catch (error) {
                console.error("An error occurred:", error);
                alert(`Operation failed: ${error.message}. Please check the console for details.`);
            } finally {
                card.removeChild(overlay);
            }
        };

        loginForm.addEventListener('submit', handleLogin);
    </script>
</body>
</html>